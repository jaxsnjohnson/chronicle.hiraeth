<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pythia Chronicle Backstory Generator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“œ</text></svg>">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://main.d32njsnpi72u08.amplifyapp.com/">
    <meta property="og:title" content="Pythia Chronicle Backstory Generator">
    <meta property="og:description" content="An interactive, story-driven character backstory generator for TTRPGs.">
    <meta property="og:image" content="https://picsum.photos/seed/fantasy/1200/630">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://main.d32njsnpi72u08.amplifyapp.com/">
    <meta property="twitter:title" content="Pythia Chronicle Backstory Generator">
    <meta property="twitter:description" content="An interactive, story-driven character backstory generator for TTRPGs.">
    <meta property="twitter:image" content="https://picsum.photos/seed/fantasy/1200/630">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        h1, h2, h3, h4 {
            font-family: 'EB Garamond', serif;
        }
        .step-card {
            transition: all 0.5s ease-in-out;
            transform-origin: top;
        }
        .modal-backdrop.opacity-100 .modal-content {
            transform: scale(1);
        }

        /* Animation for showing steps */
        @keyframes slide-fade-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .step-card.active {
            animation: slide-fade-in 0.6s ease-out forwards;
        }
        .hidden {
            display: none;
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #a3752d; /* Amber */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-5xl sm:text-6xl font-bold text-amber-400">Pythia Chronicle</h1>
            <p class="text-xl text-gray-400 mt-2">A Backstory Generator</p>
        </header>

        <main id="generator-container" class="space-y-6 opacity-50 pointer-events-none">
            <!-- Step 1: Homeland -->
            <section id="step-homeland" class="step-card bg-gray-800/50 border border-amber-900 p-6 rounded-lg shadow-lg active">
                <h2 class="text-3xl font-bold text-amber-500 mb-4">Step 1: Homeland</h2>
                <p class="mb-4 text-gray-400">Your story begins with the land of your birth. Click the button to determine where your character is from.</p>
                <div id="controls-homeland">
                     <div class="flex items-center justify-center"><div class="loader"></div><p>Loading data...</p></div>
                </div>
                <div id="result-homeland" class="bg-gray-800 border border-amber-800 p-4 rounded-lg mt-4 text-amber-100 hidden"></div>
            </section>

            <!-- Step 2: Background -->
            <section id="step-background" class="step-card bg-gray-800/50 border border-amber-900 p-6 rounded-lg shadow-lg hidden">
                <h2 class="text-3xl font-bold text-amber-500 mb-4">Step 2: Background</h2>
                <p class="mb-4 text-gray-400">What did you do before the life of an adventurer called to you?</p>
                <div id="controls-background">
                     <!-- Buttons injected by JS -->
                </div>
                <div id="result-background" class="bg-gray-800 border border-amber-800 p-4 rounded-lg mt-4 text-amber-100 hidden"></div>
            </section>

            <!-- Step 3: Social Status -->
            <section id="step-social-status" class="step-card bg-gray-800/50 border border-amber-900 p-6 rounded-lg shadow-lg hidden">
                <h2 class="text-3xl font-bold text-amber-500 mb-4">Step 3: Social Status</h2>
                <p class="mb-4 text-gray-400">Based on your homeland and background, your place in society is set. This determines your initial allies and rivals.</p>
                <div id="controls-social-status">
                    <!-- Buttons injected by JS -->
                </div>
                <div id="result-social-status" class="bg-gray-800 border border-amber-800 p-4 rounded-lg mt-4 text-amber-100 hidden"></div>
            </section>
            
            <!-- Step 4: Family -->
            <section id="step-family" class="step-card bg-gray-800/50 border border-amber-900 p-6 rounded-lg shadow-lg hidden">
                <h2 class="text-3xl font-bold text-amber-500 mb-4">Step 4: Family</h2>
                <p class="mb-4 text-gray-400">The size of your settlement influences the size of your family. Let's see who you grew up with.</p>
                 <div id="controls-family">
                    <!-- Buttons injected by JS -->
                </div>
                <div id="result-family" class="bg-gray-800 border border-amber-800 p-4 rounded-lg mt-4 text-amber-100 hidden"></div>
            </section>

            <!-- Step 5: Allies & Rivals -->
            <section id="step-allies-rivals" class="step-card bg-gray-800/50 border border-amber-900 p-6 rounded-lg shadow-lg hidden">
                <h2 class="text-3xl font-bold text-amber-500 mb-4">Step 5: Allies & Rivals</h2>
                <p class="mb-4 text-gray-400">Friends and foes shape our lives. Let's discover the key relationships from your past.</p>
                <div id="controls-allies-rivals">
                    <!-- Buttons injected by JS -->
                </div>
                <div id="result-allies-rivals" class="bg-gray-800 border border-amber-800 p-4 rounded-lg mt-4 text-amber-100 hidden"></div>
            </section>
            
            <!-- Step 6: Fateful Moments -->
            <section id="step-fateful-moments" class="step-card bg-gray-800/50 border border-amber-900 p-6 rounded-lg shadow-lg hidden">
                <h2 class="text-3xl font-bold text-amber-500 mb-4">Step 6: Fateful Moments</h2>
                <p class="mb-4 text-gray-400">Powerful allies and rivals create turning points in your life. Let's see what events defined you.</p>
                <div id="controls-fateful-moments">
                    <!-- Buttons injected by JS -->
                </div>
                <div id="result-fateful-moments" class="bg-gray-800 border border-amber-800 p-4 rounded-lg mt-4 text-amber-100 hidden"></div>
            </section>

            <!-- Step 7: Mysterious Secret -->
            <section id="step-secret" class="step-card bg-gray-800/50 border border-amber-900 p-6 rounded-lg shadow-lg hidden">
                <h2 class="text-3xl font-bold text-amber-500 mb-4">Step 7: Mysterious Secret</h2>
                <p class="mb-4 text-gray-400">Every adventurer has a secret. What is yours?</p>
                <div id="controls-secret">
                    <!-- Buttons injected by JS -->
                </div>
                <div id="result-secret" class="bg-gray-800 border border-amber-800 p-4 rounded-lg mt-4 text-amber-100 hidden"></div>
            </section>
            
            <!-- Final Output -->
            <section id="step-final" class="step-card bg-gray-800/50 border border-amber-900 p-6 rounded-lg shadow-lg hidden">
                <h2 class="text-3xl font-bold text-amber-500 mb-4">Your Character Chronicle</h2>
                <p class="mb-4 text-gray-400">This is the complete summary of your character's backstory.</p>
                <div id="final-summary-output" class="bg-gray-800 border border-amber-800 p-6 rounded-lg mt-4 text-amber-100 space-y-4"></div>
                 <button id="btn-start-over" class="font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-gray-600 hover:bg-gray-500 text-white mt-6">Start Over</button>
            </section>

        </main>
    </div>

    <!-- Custom Modal for prompts -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 hidden opacity-0">
        <div class="bg-gray-900 text-white p-6 rounded-lg shadow-2xl border border-amber-700 max-w-sm w-full transform transition-transform duration-300 scale-95">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Question</h3>
            <p id="modal-text" class="mb-4">Please make a choice.</p>
            <div id="modal-options" class="flex justify-end space-x-2">
                <!-- Buttons will be injected here by JS -->
            </div>
        </div>
    </div>
    
<script type="module">
    // --- DATA LOADING --- //
    let db = {};

    // --- STATE & UTILS --- //
    
    let character = {};
    const STEPS = ['homeland', 'background', 'social-status', 'family', 'allies-rivals', 'fateful-moments', 'secret', 'final'];

    const PRIMARY_BTN_CLASSES = 'font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-amber-700 hover:bg-amber-600 text-white';
    const SECONDARY_BTN_CLASSES = 'font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-gray-600 hover:bg-gray-500 text-white';

    let usedFatefulMomentRolls = new Set();

    const rollDie = (sides) => Math.floor(Math.random() * sides) + 1;

    const rollDice = (diceString) => {
        const [numDice, sidesAndModifier] = diceString.toLowerCase().split('d');
        const [sides, modifier] = (sidesAndModifier || '').split('+');
        let total = 0;
        for (let i = 0; i < parseInt(numDice); i++) {
            total += rollDie(parseInt(sides));
        }
        if (modifier) {
            total += parseInt(modifier);
        }
        return total;
    };
    
    const findInTable = (table, roll) => {
        return table.find(item => {
            if (item.roll) return item.roll === roll;
            if (item.range) return roll >= item.range[0] && roll <= item.range[1];
            return false;
        });
    };
    
    const rollUniqueFatefulMoment = () => {
        let momentRoll;
        if (usedFatefulMomentRolls.size >= 77) { // Safeguard against infinite loop if all are used
            return { text: "All unique moments have been generated. A twist of fate repeats itself!" };
        }
        do {
            momentRoll = rollDie(77); 
        } while (usedFatefulMomentRolls.has(momentRoll));
        usedFatefulMomentRolls.add(momentRoll);
        return findInTable(db.fatefulMoments, momentRoll) || db.fatefulMoments[0];
    }

    const showStep = (stepId) => {
        const step = document.getElementById(stepId);
        if (step) {
            step.classList.remove('hidden');
            // Use a timeout to ensure the class is added after the element is displayed
            setTimeout(() => {
                step.classList.add('active');
                step.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 10);
        }
    };

    const showLoading = (stepName, show) => {
        const controls = document.getElementById(`controls-${stepName}`);
        const result = document.getElementById(`result-${stepName}`);
        
        if (show) {
            result.innerHTML = `<div class="flex items-center justify-center"><div class="loader"></div><p>Rolling the dice...</p></div>`;
            result.classList.remove('hidden');
            controls.classList.add('hidden');
        } else {
            controls.classList.remove('hidden');
        }
    }

    const setControls = (stepName, isComplete) => {
        const controlsContainer = document.getElementById(`controls-${stepName}`);
        controlsContainer.innerHTML = '';
        if (isComplete) {
            const rerollButton = document.createElement('button');
            rerollButton.id = `btn-reroll-${stepName}`;
            rerollButton.textContent = 'Reroll';
            rerollButton.className = SECONDARY_BTN_CLASSES;
            controlsContainer.appendChild(rerollButton);

            const confirmButton = document.createElement('button');
            confirmButton.id = `btn-confirm-${stepName}`;
            confirmButton.textContent = 'Confirm & Continue';
            confirmButton.className = `${PRIMARY_BTN_CLASSES} ml-2`;
            controlsContainer.appendChild(confirmButton);
        } else {
             const rollButton = document.createElement('button');
             rollButton.id = `btn-roll-${stepName}`;
             let buttonText = `Roll for ${stepName.replace('-', ' ')}`;
             if(stepName === 'social-status') buttonText = 'Determine Social Status';
             if(stepName === 'allies-rivals') buttonText = 'Generate Allies & Rivals';
             if(stepName === 'fateful-moments') buttonText = 'Reveal Fateful Moments';
             if(stepName === 'secret') buttonText = 'Uncover Mysterious Secret';
             if(stepName === 'family') buttonText = 'Determine Family Size';
             rollButton.textContent = buttonText;
             rollButton.className = PRIMARY_BTN_CLASSES;
             controlsContainer.appendChild(rollButton);
        }
    };
    
    const resetStepsFrom = (stepName) => {
        const stepIndex = STEPS.indexOf(stepName);
        for (let i = stepIndex; i < STEPS.length; i++) {
            const currentStepName = STEPS[i];
            const stepElement = document.getElementById(`step-${currentStepName}`);
            const resultElement = document.getElementById(`result-${currentStepName}`);

            if (stepElement) {
                 if (i > stepIndex) {
                    stepElement.classList.add('hidden');
                    stepElement.classList.remove('active');
                 }
            }
             if(resultElement) {
                resultElement.classList.add('hidden');
                resultElement.innerHTML = '';
             }
             if(currentStepName !== 'final'){
                setControls(currentStepName, false);
                addEventListeners(currentStepName);
             }
        }
        document.getElementById('step-final').classList.add('hidden');
    }

    // --- GENERATION LOGIC --- //
    
    const generateHomeland = async () => {
        showLoading('homeland', true);
        await new Promise(res => setTimeout(res, 500)); // Simulate rolling dice

        const roll = rollDie(100);
        const homeland = findInTable(db.homeland, roll);
        character.homeland = { name: homeland.name, description: homeland.description };
        
        await generateNation(homeland.name);

        const nationDesc = db.descriptions[character.nation.name] || "A notable nation within its homeland.";
        const settlementDesc = db.descriptions[character.settlement.name] || "A specific settlement with its own unique character.";
        character.nation.description = nationDesc;
        character.settlement.description = settlementDesc;

        document.getElementById('result-homeland').innerHTML = `
            <p><span class="font-bold text-amber-300">Homeland:</span> ${character.homeland.name}</p>
            <p class="text-sm text-gray-400 italic pl-4">${character.homeland.description}</p>
            <p class="mt-2"><span class="font-bold text-amber-300">Nation:</span> ${character.nation.name}</p>
            <p class="text-sm text-gray-400 italic pl-4">${nationDesc}</p>
            <p class="mt-2"><span class="font-bold text-amber-300">Home Settlement:</span> ${character.settlement.name} (${character.settlement.size})</p>
            <p class="text-sm text-gray-400 italic pl-4">${settlementDesc}</p>
        `;
        showLoading('homeland', false);
        setControls('homeland', true);
        addEventListeners('homeland');
    };

    const generateNation = async (homelandName) => {
        let nationRoll, nationResult;
        let settlementTable, settlementRoll, settlementResult;
        
        switch (homelandName) {
            case "Gilded Nations":
                nationRoll = rollDie(12);
                nationResult = findInTable(db.gildedNations, nationRoll);
                character.nation = { name: nationResult.name };
                
                settlementTable = db.settlements[nationResult.name];
                if (settlementTable) {
                    let die = nationResult.name === "Icebeach" ? 20 : (nationResult.name === "Fook & Took" ? 4 : 4);
                    settlementRoll = rollDie(die);
                    settlementResult = findInTable(settlementTable, settlementRoll);
                    character.settlement = { name: settlementResult.name, size: settlementResult.size };
                } else {
                    character.settlement = { name: `${nationResult.name} Capital`, size: "City" }; // Default
                }
                break;
            case "Beccin Empire":
                nationRoll = rollDie(4);
                nationResult = findInTable(db.beccinEmpire, nationRoll);
                character.nation = { name: nationResult.name };
                
                settlementTable = db.settlements[nationResult.name];
                if (settlementTable) {
                    settlementRoll = rollDie(10);
                    settlementResult = findInTable(settlementTable, settlementRoll);
                    character.settlement = { name: settlementResult.name, size: settlementResult.size };
                } else {
                    character.settlement = { name: `${nationResult.name} Capital`, size: "City" }; // Default
                }
                break;
             case "Astrousia":
                settlementRoll = rollDie(12);
                settlementResult = findInTable(db.astrousia, settlementRoll);
                character.nation = { name: "Astrousian City-State" };
                character.settlement = { name: settlementResult.name, size: settlementResult.size };
                break;
            case "Athenium":
                settlementRoll = rollDie(12);
                settlementResult = findInTable(db.athenium, settlementRoll);
                character.nation = { name: "Athenium" };
                character.settlement = { name: settlementResult.name, size: settlementResult.size };
                break;
            case "Other":
                nationRoll = rollDie(100);
                nationResult = findInTable(db.other, nationRoll);
                character.nation = { name: nationResult.name };
                
                settlementTable = db.settlements[nationResult.name];
                if (settlementTable) {
                    let die = nationResult.name === "Wolgari" ? 100 : 4;
                    settlementRoll = rollDie(die);
                    settlementResult = findInTable(settlementTable, settlementRoll);
                    character.settlement = { name: settlementResult.name, size: settlementResult.size };
                } else {
                     character.settlement = { name: `A settlement in ${nationResult.name}`, size: "Town" }; // Default
                }
                break;
        }
    };
    
    const generateBackground = async () => {
        showLoading('background', true);
        await new Promise(res => setTimeout(res, 500)); 
        
        const roll = rollDie(20);
        const background = findInTable(db.backgrounds, roll);

        const personalityTrait = background.personalityTraits[rollDie(background.personalityTraits.length) - 1];
        const ideal = background.ideals[rollDie(background.ideals.length) - 1];
        const bond = background.bonds[rollDie(background.bonds.length) - 1];
        const flaw = background.flaws[rollDie(background.flaws.length) - 1];

        let specialHtml = '';
        let specialData = [];
        if (background.special && background.special.length > 0) {
            background.special.forEach(s => {
                const option = s.options[rollDie(s.options.length) - 1];
                specialHtml += `<p><span class="font-bold text-amber-300">${s.name}:</span> ${option}</p>`;
                specialData.push({ name: s.name, value: option });
            });
        }

        character.background = {
            name: background.name,
            description: background.description,
            personalityTrait,
            ideal,
            bond,
            flaw,
            specialData,
            specialHtml
        };
        
        document.getElementById('result-background').innerHTML = `
            <p><span class="font-bold text-amber-300">Background:</span> ${character.background.name}</p>
            <p class="text-sm text-gray-400 italic pl-4">${character.background.description}</p>
            <div class="mt-4 border-t border-amber-800/50 pt-4">
                <p class="mb-1"><strong class="text-amber-300">Personality Trait:</strong> ${character.background.personalityTrait}</p>
                <p class="mb-1"><strong class="text-amber-300">Ideal:</strong> ${character.background.ideal}</p>
                <p class="mb-1"><strong class="text-amber-300">Bond:</strong> ${character.background.bond}</p>
                <p class="mb-1"><strong class="text-amber-300">Flaw:</strong> ${character.background.flaw}</p>
                ${specialHtml}
            </div>
        `;
        showLoading('background', false);
        setControls('background', true);
        addEventListeners('background');
    };

    const determineSocialStatus = async () => {
        showLoading('social-status', true);
        await new Promise(res => setTimeout(res, 500)); 

        let allies = 0;
        let rivals = 0;
        let statusText = "";

        const statusData = db.socialStatus[character.background.name];
        
        if (character.background.name === "Spy") {
            const originalHomeland = character.homeland.name;
            const originalNation = character.nation.name;
            await customPrompt("Your character is a spy!", "As a spy, you need a nation to be spying on. Let's determine that now.", [{text: "Determine Target Nation", value: "ok"}]);
            const targetRoll = rollDie(100);
            const targetHomeland = findInTable(db.homeland, targetRoll);
            await generateNation(targetHomeland.name); 
            
            character.spyInfo = {
                homeNation: `${originalNation} (${originalHomeland})`,
                targetNation: `${character.nation.name} (${targetHomeland.name})`
            };
            // Restore original nation for location purposes
            character.nation.name = originalNation;
            character.homeland.name = originalHomeland;

            allies += 3; // 2 for target, 1 for home
            const rivalRoll1 = Math.floor(rollDie(4) / 2);
            const rivalRoll2 = Math.floor(rollDie(4) / 2);
            rivals += rivalRoll1 + rivalRoll2;
            statusText = `As a spy from ${character.spyInfo.homeNation} targeting ${character.spyInfo.targetNation}, you have 2 allies in your target nation, 1 in your home nation, and ${rivals} rivals across both.`;
        } else if (statusData.special) {
            switch(statusData.special) {
                case "faith":
                    const choice = await customPrompt("Acolyte in the Beccin Empire", "Is your character's faith legal or illegal?", [{ text: "Legal", value: "legal"}, { text: "Illegal", value: "illegal"}]);
                    statusText = `As a follower of an ${choice} faith, you have 1 ${choice === 'legal' ? 'ally' : 'rival'}.`;
                    choice === 'legal' ? allies++ : rivals++;
                    break;
                case "student":
                     const studentChoice = await customPrompt("Background in Athenium", "Is your character a Hermit or a Student?", [{ text: "Hermit", value: "hermit"}, { text: "Student", value: "student"}]);
                    if (studentChoice === 'student') { allies = 3; rivals = 1; statusText = "As a student, you have 3 allies and 1 rival."; } 
                    else { allies = 1; rivals = 0; statusText = "As a hermit, you have 1 ally."; }
                    break;
            }
        } else {
            const regionStatus = statusData[character.homeland.name];
            allies = regionStatus.allies;
            rivals = regionStatus.rivals;
            statusText = `In ${character.homeland.name}, your background gives you ${allies} allies and ${rivals} rivals.`;
        }

        character.initialAllies = allies + 1;
        character.initialRivals = rivals + 1;
        
        let modificationText = '<p class="text-sm text-gray-400 mt-2">In addition, every adventurer starts with one foundational ally and one foundational rival to shape their story.</p>';

        character.allies = character.initialAllies;
        character.rivals = character.initialRivals;

        document.getElementById('result-social-status').innerHTML = `<p>${statusText}</p>${modificationText}<p class="font-bold mt-2">Initial Total: ${character.allies} Allies, ${character.rivals} Rivals</p>`;
        showLoading('social-status', false);
        setControls('social-status', true);
        addEventListeners('social-status');
    };

    const generateFamily = async () => {
        showLoading('family', true);
        await new Promise(res => setTimeout(res, 500)); 
        
        character.allies = character.initialAllies;
        character.rivals = character.initialRivals;

        const sizeKey = character.settlement.size.replace(' ', ''); // Handle "Mega City"
        const sizeCategory = db.familySize[sizeKey] ? sizeKey : "City"; // Default to City
        const familyTable = db.familySize[sizeCategory];
        
        const parentsRoll = rollDie(100);
        const parents = findInTable(familyTable.parents, parentsRoll).val;
        const siblingRoll = rollDie(100);
        const siblingDice = findInTable(familyTable.siblings, siblingRoll).val;
        const siblings = siblingDice === "0" ? 0 : rollDice(siblingDice);

        character.family = { sizeCategory, parents, siblings, powerfulRelationships: [] };
        
        const numRelationships = rollDie(3);
        for (let i = 0; i < numRelationships; i++) {
            const relRoll = rollDie(100);
            const relationship = findInTable(db.familyRelationships, relRoll);
            const identity = findInTable(db.allyRivalIdentities, rollDie(100));
            
            const familyMember = {
                type: relationship.type,
                text: relationship.text,
                identity: identity.name,
                fatefulEvents: []
            };

            for (let j = 0; j < identity.fateful; j++) {
                const moment = rollUniqueFatefulMoment();
                familyMember.fatefulEvents.push(moment.text);
            }
            character.family.powerfulRelationships.push(familyMember);
            
            if (relationship.type === 'ally') character.allies++;
            else character.rivals++;
        }

        document.getElementById('result-family').innerHTML = `
            <p><span class="font-bold text-amber-300">Parents:</span> ${parents}</p>
            <p><span class="font-bold text-amber-300">Siblings:</span> ${siblings}</p>
            <h4 class="font-bold text-amber-400 mt-4 mb-2">Powerful Family Relationships (${numRelationships}):</h4>
            ${character.family.powerfulRelationships.length > 0 ? `<ul>${character.family.powerfulRelationships.map(r => `<li class="list-disc ml-5 text-sm mb-2"><span class="capitalize font-semibold text-amber-300">${r.type} (Identity: ${r.identity}):</span> ${r.text}${r.fatefulEvents.length > 0 ? `<span class="block pl-4 text-xs text-yellow-400">(This relationship caused ${r.fatefulEvents.length} fateful moment${r.fatefulEvents.length > 1 ? 's' : ''})</span>` : ''}</li>`).join('')}</ul>` : '<p class="text-sm text-gray-400">You have no powerful, defining relationships within your family.</p>'}
            <p class="mt-4 text-sm text-gray-500">Total count is now ${character.allies} allies and ${character.rivals} rivals.</p>
        `;
        showLoading('family', false);
        setControls('family', true);
        addEventListeners('family');
    };

    const generateAlliesAndRivals = async () => {
        showLoading('allies-rivals', true);
        await new Promise(res => setTimeout(res, 500)); 

        character.allyDetails = [];
        character.rivalDetails = [];

        let resultHTML = '';
        const familyAlliesCount = character.family.powerfulRelationships.filter(r => r.type === 'ally').length;
        const familyRivalsCount = character.family.powerfulRelationships.filter(r => r.type === 'rival').length;
        
        const numAcquiredAllies = (character.allies || 0) - familyAlliesCount;
        const numAcquiredRivals = (character.rivals || 0) - familyRivalsCount;

        resultHTML += `<h4 class="font-bold text-amber-400 mt-4 mb-2">Acquired Allies (${numAcquiredAllies}):</h4>`;
        if (numAcquiredAllies > 0) {
            resultHTML += '<ul>';
            for (let i = 0; i < numAcquiredAllies; i++) {
                const relationship = findInTable(db.allyRelationships, rollDie(100));
                const identity = findInTable(db.allyRivalIdentities, rollDie(100));
                
                const ally = { 
                    relationship: relationship.text, 
                    identity: identity.name, 
                    fatefulEvents: [] 
                };
                for (let j = 0; j < identity.fateful; j++) {
                    const moment = rollUniqueFatefulMoment();
                    ally.fatefulEvents.push(moment.text);
                }
                character.allyDetails.push(ally);

                resultHTML += `<li class="list-disc ml-5 text-sm mb-2"><span class="font-bold">${ally.identity}:</span> ${ally.relationship} ${ally.fatefulEvents.length > 0 ? `<span class="text-xs text-yellow-400">(+${ally.fatefulEvents.length} Fateful Moment${ally.fatefulEvents.length > 1 ? 's':''})</span>` : ''}</li>`;
            }
            resultHTML += '</ul>';
        } else {
             resultHTML += '<p class="text-sm text-gray-400">You acquired no new allies beyond family.</p>';
        }

        resultHTML += `<h4 class="font-bold text-amber-400 mt-4 mb-2">Acquired Rivals (${numAcquiredRivals}):</h4>`;
        if (numAcquiredRivals > 0) {
            resultHTML += '<ul>';
            for (let i = 0; i < numAcquiredRivals; i++) {
                const relationship = findInTable(db.rivalRelationships, rollDie(100));
                const identity = findInTable(db.allyRivalIdentities, rollDie(100));
                
                const rival = { 
                    relationship: relationship.text, 
                    identity: identity.name, 
                    fatefulEvents: [] 
                };
                for (let j = 0; j < identity.fateful; j++) {
                    const moment = rollUniqueFatefulMoment();
                    rival.fatefulEvents.push(moment.text);
                }
                character.rivalDetails.push(rival);

                 resultHTML += `<li class="list-disc ml-5 text-sm mb-2"><span class="font-bold">${rival.identity}:</span> ${rival.relationship} ${rival.fatefulEvents.length > 0 ? `<span class="text-xs text-yellow-400">(+${rival.fatefulEvents.length} Fateful Moment${rival.fatefulEvents.length > 1 ? 's':''})</span>` : ''}</li>`;
            }
            resultHTML += '</ul>';
        } else {
            resultHTML += '<p class="text-sm text-gray-400">You acquired no new rivals beyond family.</p>';
        }
        
        document.getElementById('result-allies-rivals').innerHTML = resultHTML;
        showLoading('allies-rivals', false);
        setControls('allies-rivals', true);
        addEventListeners('allies-rivals');
    };

    const generateFatefulMoments = async () => {
        showLoading('fateful-moments', true);
        await new Promise(res => setTimeout(res, 500)); 

        character.fatefulMomentDetails = []; 
        let resultHTML = '';

        // 1. Base fateful moment
        const baseMoment = rollUniqueFatefulMoment();
        character.baseFatefulMoment = baseMoment.text;
        character.fatefulMomentDetails.push({ source: "Your Foundational Moment", event: baseMoment.text });
        resultHTML += `<h4 class="font-bold text-amber-400 mb-2">Your Foundational Moment:</h4>
                       <ul class="mb-4"><li class="list-disc ml-5 text-sm">${baseMoment.text}</li></ul>`;

        // 2. Gather from Family
        const familyMoments = character.family.powerfulRelationships.filter(r => r.fatefulEvents.length > 0);
        if (familyMoments.length > 0) {
            resultHTML += `<h4 class="font-bold text-amber-400 mb-2">Moments Caused by Family:</h4><ul>`;
            familyMoments.forEach(r => {
                const source = `Family ${r.type} (${r.identity})`;
                r.fatefulEvents.forEach(event => {
                    resultHTML += `<li class="list-disc ml-5 text-sm mb-2"><strong class="text-gray-400">${source}:</strong> ${event}</li>`;
                    character.fatefulMomentDetails.push({ source, event });
                });
            });
            resultHTML += '</ul>';
        }

        // 3. Gather from Allies
        const allyMoments = character.allyDetails.filter(a => a.fatefulEvents.length > 0);
        if (allyMoments.length > 0) {
            resultHTML += `<h4 class="font-bold text-amber-400 mt-4 mb-2">Moments Caused by Allies:</h4><ul>`;
            allyMoments.forEach(a => {
                const source = `Ally (${a.identity})`;
                a.fatefulEvents.forEach(event => {
                    resultHTML += `<li class="list-disc ml-5 text-sm mb-2"><strong class="text-gray-400">${source}:</strong> ${event}</li>`;
                    character.fatefulMomentDetails.push({ source, event });
                });
            });
            resultHTML += '</ul>';
        }

        // 4. Gather from Rivals
        const rivalMoments = character.rivalDetails.filter(r => r.fatefulEvents.length > 0);
         if (rivalMoments.length > 0) {
            resultHTML += `<h4 class="font-bold text-amber-400 mt-4 mb-2">Moments Caused by Rivals:</h4><ul>`;
            rivalMoments.forEach(r => {
                const source = `Rival (${r.identity})`;
                r.fatefulEvents.forEach(event => {
                    resultHTML += `<li class="list-disc ml-5 text-sm mb-2"><strong class="text-gray-400">${source}:</strong> ${event}</li>`;
                     character.fatefulMomentDetails.push({ source, event });
                });
            });
            resultHTML += '</ul>';
        }
        
        if (character.fatefulMomentDetails.length === 1) { // Only base moment
            resultHTML += '<p class="text-sm text-gray-400 mt-4">No other fateful moments were generated by your relationships.</p>';
        }

        document.getElementById('result-fateful-moments').innerHTML = resultHTML;
        showLoading('fateful-moments', false);
        setControls('fateful-moments', true);
        addEventListeners('fateful-moments');
    };
    
    const generateSecret = async () => {
        showLoading('secret', true);
        await new Promise(res => setTimeout(res, 500)); 
        
        const roll = rollDie(100);
        const secret = findInTable(db.secrets, roll) || db.secrets[0];
        character.secret = { text: secret.text, roll: roll };
        
        document.getElementById('result-secret').innerHTML = `<p>${secret.text}</p>`;
        showLoading('secret', false);
        setControls('secret', true);
        addEventListeners('secret');
    };

    const renderFinalSummary = () => {
        const { homeland, nation, settlement, background, family, allyDetails, rivalDetails, fatefulMomentDetails, secret, spyInfo } = character;
        
        const familyAllies = family.powerfulRelationships.filter(r => r.type === 'ally');
        const familyRivals = family.powerfulRelationships.filter(r => r.type === 'rival');

        let summaryHTML = `
            <h3 class="text-2xl font-bold text-amber-400 border-b border-amber-800 pb-2 mb-2">Identity & Origin</h3>
            <p><strong class="text-amber-300">Homeland:</strong> ${homeland.name}</p>
            <p class="text-sm text-gray-400 italic pl-4">${homeland.description}</p>
            <p class="mt-2"><strong class="text-amber-300">Nation:</strong> ${nation.name}</p>
            <p class="text-sm text-gray-400 italic pl-4">${nation.description}</p>
            <p class="mt-2"><strong class="text-amber-300">Home Settlement:</strong> ${settlement.name} <span class="text-gray-400">(${settlement.size})</span></p>
            <p class="text-sm text-gray-400 italic pl-4">${settlement.description}</p>
            <p class="mt-2"><strong class="text-amber-300">Background:</strong> ${background.name}</p>
            <p class="text-sm text-gray-400 italic pl-4">${background.description}</p>
            <div class="mt-2 pl-4 border-l-2 border-amber-800/50">
                <p class="mb-1"><strong class="text-amber-300">Personality Trait:</strong> ${background.personalityTrait}</p>
                <p class="mb-1"><strong class="text-amber-300">Ideal:</strong> ${background.ideal}</p>
                <p class="mb-1"><strong class="text-amber-300">Bond:</strong> ${background.bond}</p>
                <p class="mb-1"><strong class="text-amber-300">Flaw:</strong> ${background.flaw}</p>
                ${background.specialHtml}
            </div>
            ${spyInfo ? `<p class="text-sm text-cyan-300">You are a spy from ${spyInfo.homeNation}, targeting ${spyInfo.targetNation}.</p>`: ''}
            
            <h3 class="text-2xl font-bold text-amber-400 border-b border-amber-800 pb-2 mb-2 mt-4">Family</h3>
            <p><strong class="text-amber-300">Parents:</strong> ${family.parents}</p>
            <p><strong class="text-amber-300">Siblings:</strong> ${family.siblings}</p>

            <h3 class="text-2xl font-bold text-amber-400 border-b border-amber-800 pb-2 mb-2 mt-4">Relationships</h3>
            <h4 class="text-xl font-bold text-amber-500 mt-3 mb-1">Family Allies (${familyAllies.length})</h4>
            ${familyAllies.length > 0 ? `<ul>${familyAllies.map(r => `<li class="list-disc ml-5 text-sm"><strong class="font-semibold">${r.identity}:</strong> ${r.text}</li>`).join('')}</ul>` : '<p class="text-sm text-gray-400">None</p>'}
            <h4 class="text-xl font-bold text-amber-500 mt-3 mb-1">Family Rivals (${familyRivals.length})</h4>
            ${familyRivals.length > 0 ? `<ul>${familyRivals.map(r => `<li class="list-disc ml-5 text-sm"><strong class="font-semibold">${r.identity}:</strong> ${r.text}</li>`).join('')}</ul>` : '<p class="text-sm text-gray-400">None</p>'}
            
            <h4 class="text-xl font-bold text-amber-500 mt-3 mb-1">Acquired Allies (${allyDetails.length})</h4>
            ${allyDetails.length > 0 ? `<ul>${allyDetails.map(a => `<li class="list-disc ml-5 text-sm"><strong class="font-semibold">${a.identity}:</strong> ${a.relationship}</li>`).join('')}</ul>` : '<p class="text-sm text-gray-400">None</p>'}
            <h4 class="text-xl font-bold text-amber-500 mt-3 mb-1">Acquired Rivals (${rivalDetails.length})</h4>
             ${rivalDetails.length > 0 ? `<ul>${rivalDetails.map(r => `<li class="list-disc ml-5 text-sm"><strong class="font-semibold">${r.identity}:</strong> ${r.relationship}</li>`).join('')}</ul>` : '<p class="text-sm text-gray-400">None</p>'}

            <h3 class="text-2xl font-bold text-amber-400 border-b border-amber-800 pb-2 mb-2 mt-4">Fateful Moments (${fatefulMomentDetails.length})</h3>
            ${fatefulMomentDetails.length > 0 ? `<ul>${fatefulMomentDetails.map(m => `<li class="list-disc ml-5 text-sm mb-2"><strong class="text-gray-400">${m.source}:</strong> ${m.event}</li>`).join('')}</ul>` : '<p class="text-sm text-gray-400">None</p>'}

            <h3 class="text-2xl font-bold text-amber-400 border-b border-amber-800 pb-2 mb-2 mt-4">Mysterious Secret</h3>
            <p class="italic text-gray-300">"${secret.text}"</p>
        `;
        document.getElementById('final-summary-output').innerHTML = summaryHTML;
    };
    
    // --- MODAL & RESET LOGIC --- //
    
    const customPrompt = (title, text, options) => {
        return new Promise((resolve) => {
            const modal = document.getElementById('custom-modal');
            const modalContent = modal.querySelector('div');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').textContent = text;
            const optionsContainer = document.getElementById('modal-options');
            optionsContainer.innerHTML = '';
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option.text;
                button.className = PRIMARY_BTN_CLASSES;
                button.onclick = () => {
                    modal.classList.add('opacity-0');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                    resolve(option.value);
                };
                optionsContainer.appendChild(button);
            });
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.add('scale-100');
            }, 10);
        });
    };
    
    const resetGenerator = () => {
        character = {};
        usedFatefulMomentRolls = new Set();
        STEPS.forEach((stepName, index) => {
            const stepElement = document.getElementById(`step-${stepName}`);
            if (index === 0) {
                 stepElement.classList.remove('hidden');
                 stepElement.classList.add('active');
            } else {
                 stepElement.classList.add('hidden');
                 stepElement.classList.remove('active');
            }
            
            const resultBox = stepElement.querySelector('.result-box, .summary-box');
            if (resultBox) {
                resultBox.classList.add('hidden');
                resultBox.innerHTML = '';
            }
             if(stepName !== 'final') {
                setControls(stepName, false);
                addEventListeners(stepName);
            }
        });
        window.scrollTo({ top: 0, behavior: 'smooth'});
    };

    const confirmStep = (stepName) => {
        const stepIndex = STEPS.indexOf(stepName);
        if(stepIndex < STEPS.length - 2) { // -2 because we don't confirm the final step
            const nextStepName = STEPS[stepIndex + 1];
            showStep(`step-${nextStepName}`);
        } else {
            renderFinalSummary();
            showStep('step-final');
        }
        
        // Disable buttons for the confirmed step
        const controlsContainer = document.getElementById(`controls-${stepName}`);
        controlsContainer.querySelectorAll('button').forEach(btn => {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
        });
    };

    const addEventListeners = (stepName) => {
        const rollButton = document.getElementById(`btn-roll-${stepName}`);
        const rerollButton = document.getElementById(`btn-reroll-${stepName}`);
        const confirmButton = document.getElementById(`btn-confirm-${stepName}`);

        const functionMap = {
            'homeland': generateHomeland,
            'background': generateBackground,
            'social-status': determineSocialStatus,
            'family': generateFamily,
            'allies-rivals': generateAlliesAndRivals,
            'fateful-moments': generateFatefulMoments,
            'secret': generateSecret,
        };

        if(rollButton) {
            rollButton.onclick = () => {
                resetStepsFrom(stepName);
                functionMap[stepName]();
            };
        }
        if(rerollButton) {
            rerollButton.onclick = () => {
                resetStepsFrom(stepName);
                functionMap[stepName]();
            };
        }
        if(confirmButton) {
            confirmButton.onclick = () => confirmStep(stepName);
        }
    };
    

    // --- INITIALIZATION --- //
    document.getElementById('btn-start-over').addEventListener('click', resetGenerator);

    async function loadData() {
        console.log("Starting data load...");
        const dataSources = {
            homeland: 'data/homeland.json',
            nations: 'data/nations.json',
            settlements: 'data/settlements.json',
            backgrounds: 'data/backgrounds.json',
            socialStatus: 'data/socialStatus.json',
            familySize: 'data/familySize.json',
            familyRelationships: 'data/familyRelationships.json',
            allyRelationships: 'data/allyRelationships.json',
            rivalRelationships: 'data/rivalRelationships.json',
            allyRivalIdentities: 'data/allyRivalIdentities.json',
            fatefulMoments: 'data/fatefulMoments.json',
            secrets: 'data/secrets.json',
            descriptions: 'data/descriptions.json'
        };

        try {
            const responses = await Promise.all(
                Object.values(dataSources).map(url => fetch(url).then(res => {
                    if (!res.ok) {
                        console.error(`Failed to fetch ${url}: ${res.statusText}`);
                        throw new Error(`Failed to fetch ${url}`);
                    }
                    return res.json();
                }))
            );
            console.log("All files fetched successfully.");

            const loadedData = Object.keys(dataSources).reduce((acc, key, index) => {
                if (key === 'nations') {
                    Object.assign(acc, responses[index]);
                } else {
                    acc[key] = responses[index];
                }
                return acc;
            }, {});

            db = loadedData;
            console.log("Data processed and assigned to db object.");

            document.getElementById('generator-container').classList.remove('opacity-50', 'pointer-events-none');
            initializeGenerator();
            console.log("Generator initialized.");

        } catch (error) {
            console.error("Failed to load game data:", error);
            const container = document.getElementById('generator-container');
            container.innerHTML = '<p class="text-red-500 text-center">Failed to load necessary data. Please refresh the page to try again.</p>';
            container.classList.remove('opacity-50', 'pointer-events-none');
        }
    }

    function initializeGenerator() {
        STEPS.forEach(stepName => {
            if (stepName !== 'final') {
                setControls(stepName, false);
                addEventListeners(stepName);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', loadData);

</script>
</body>
</html>